## 分布式锁设计-基于Mysql


### 功能需求
- 互斥性
- 过期时间 或 租期机制
- 高性能
  - 低延时
  - 低cpu占用(未获取到锁时，立即返回，不要长时间占用cpu)
  - 杜绝惊群
- 可重入
- 公平


### 方案优缺点对比
1. 方案一 使用时间戳+唯一索引
- 优点
  - 互斥
  - ttl机制避免死锁
  - Lock / UnLock
  - 可续约 
- 缺点
  - 惊群
  - 可重入
  - 公平 

2. 方案二 使用 select.... for update 行锁
- 优点
  - 互斥, mysql内部排他锁
  - 过期时间，如果client断连(网络/机器故障), mysql会自动释放行锁
  - 抢锁失败线程会被挂起wait，不会占用cpu，
  - 可重入-mysql内部行锁支持; 可以在事物里重复执行 select ... for update 
  - 公平-mysql内部行锁支持; mysql内部会唤醒等待client,避免惊群
- 缺点
  - 如果网络断开，链接断开，事物丢失，for update 语句会时效
  - 需要提前插入到lock表一条记录